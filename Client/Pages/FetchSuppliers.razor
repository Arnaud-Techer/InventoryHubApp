@page "/fetchSuppliers"
@using InventoryHubApp.Shared.Models
@using InventoryHubApp.Client.Services
@using Client.Components
@inject IApiService ApiService

<PageTitle>Suppliers - Inventory Hub</PageTitle>

<div class="suppliers-page">
    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">
                <i class="fas fa-truck"></i>
                Suppliers Management
            </h1>
            <p class="page-description">
                Manage your suppliers and view their associated products
            </p>
        </div>
        <div class="header-actions">
            <PaginationComponent CurrentPage="currentPage" 
                                TotalPages="totalPages" 
                                HasPreviousPage="hasPreviousPage" 
                                HasNextPage="hasNextPage" 
                                OnPageChanged="LoadPage" />
            <button class="btn btn-primary" @onclick="AddNewSupplier">
                <i class="fas fa-plus"></i>
                Add Supplier
            </button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading-container">
            <div class="spinner"></div>
            <p>Loading suppliers...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="error-container">
            <div class="error-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="error-content">
                <h3>Error Loading Suppliers</h3>
                <p>@errorMessage</p>
                <button class="btn btn-secondary" @onclick="LoadSuppliers">
                    <i class="fas fa-refresh"></i>
                    Try Again
                </button>
            </div>
        </div>
    }
    else if (suppliers?.Any() == true)
    {
        <div class="suppliers-grid">
            @foreach (var supplier in suppliers)
            {
                <SupplierCard Supplier="supplier" 
                              OnEdit="EditSupplier" 
                              OnDelete="DeleteSupplier" />
            }
        </div>
    }
    else
    {
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-truck"></i>
            </div>
            <div class="empty-content">
                <h3>No Suppliers Found</h3>
                <p>Get started by adding your first supplier to the system.</p>
                <button class="btn btn-primary" @onclick="AddNewSupplier">
                    <i class="fas fa-plus"></i>
                    Add Your First Supplier
                </button>
            </div>
        </div>
    }
</div>

<AddSupplierModal IsVisible="showAddModal" 
                  OnClose="CloseAddModal" 
                  OnSupplierAdded="HandleSupplierAdded" />

<EditSupplierModal IsVisible="showEditModal" 
                   SupplierToEdit="selectedSupplier"
                   OnClose="CloseEditModal" 
                   OnSupplierUpdated="HandleSupplierUpdated" />

@code {
    private Supplier[]? suppliers;
    private bool isLoading = true;
    private string? errorMessage;
    private bool showAddModal = false;
    private bool showEditModal = false;
    private Supplier? selectedSupplier;
    
    // Pagination properties
    private int currentPage = 1;
    private int totalPages = 1;
    private bool hasPreviousPage = false;
    private bool hasNextPage = false;
    private const int pageSize = 6;

    protected override async Task OnInitializedAsync()
    {
        await LoadPage(1);
    }

    private async Task LoadPage(int pageNumber)
    {
        isLoading = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            var paginationResponse = await ApiService.GetSuppliersPaginatedAsync(pageNumber, pageSize);
            if (paginationResponse != null)
            {
                suppliers = paginationResponse.Items;
                currentPage = paginationResponse.PageNumber;
                totalPages = paginationResponse.TotalPages;
                hasPreviousPage = paginationResponse.HasPreviousPage;
                hasNextPage = paginationResponse.HasNextPage;
            }
            else
            {
                suppliers = Array.Empty<Supplier>();
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            Console.Error.WriteLine($"Error fetching suppliers: {ex.Message}");
            suppliers = Array.Empty<Supplier>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadSuppliers()
    {
        await LoadPage(1);
    }

    private void AddNewSupplier()
    {
        showAddModal = true;
        StateHasChanged();
    }

    private void CloseAddModal()
    {
        showAddModal = false;
        StateHasChanged();
    }

    private async Task HandleSupplierAdded(Supplier newSupplier)
    {
        // Refresh the suppliers list to include the new supplier
        await LoadPage(currentPage);
    }

    private void EditSupplier(Supplier supplier)
    {
        selectedSupplier = supplier;
        showEditModal = true;
        StateHasChanged();
    }

    private void CloseEditModal()
    {
        showEditModal = false;
        selectedSupplier = null;
        StateHasChanged();
    }

    private async Task HandleSupplierUpdated(Supplier updatedSupplier)
    {
        // Refresh the suppliers list to show the updated supplier
        await LoadPage(currentPage);
    }

    private void DeleteSupplier(Supplier supplier)
    {
        // TODO: Implement delete supplier functionality
        Console.WriteLine($"Delete supplier: {supplier.SupplierName}");
    }
}
