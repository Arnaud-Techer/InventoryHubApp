@using InventoryHubApp.Shared.Models;
@using InventoryHubApp.Client.Services;
@using Client.Components;
@inject InventoryHubApp.Client.Services.IApiService ApiService

@page "/fetchproducts"

<div class="products-page" @onclick="CloseDropdownIfOpen">
    <div class="page-header">
        <h2 class="page-title">
            <i class="fas fa-boxes"></i>
            Products Inventory
        </h2>
        <div class="page-actions">
            <PaginationComponent CurrentPage="currentPage" 
                                TotalPages="totalPages" 
                                HasPreviousPage="hasPreviousPage" 
                                HasNextPage="hasNextPage" 
                                OnPageChanged="LoadPage" />
            <button class="btn btn-success" @onclick="RefreshProducts">
                <i class="fas fa-sync-alt"></i>
                Refresh
            </button>
            <button class="btn btn-primary" @onclick="AddNewProduct">
                <i class="fas fa-plus"></i>
                Add Product
            </button>
            <div class="category-dropdown @(showCategoryDropdown ? "open" : "")">
                <button class="btn btn-category dropdown-toggle" @onclick="ToggleCategoryDropdown" @onclick:stopPropagation="true">
                    <i class="fas fa-list"></i>
                    Categories
                    <i class="fas fa-chevron-down"></i>
                </button>
                @if (showCategoryDropdown)
                {
                    <div class="dropdown-menu" @onclick:stopPropagation="true">
                        <button class="dropdown-item" @onclick="AddNewCategory">
                            <i class="fas fa-plus"></i>
                            Add Category
                        </button>
                        <button class="dropdown-item" @onclick="DeleteCategory">
                            <i class="fas fa-trash"></i>
                            Delete Category
                        </button>
                    </div>
                }
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading-container">
            <div class="spinner"></div>
            <p>Loading products...</p>
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="error-container">
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Error:</strong> @errorMessage
            </div>
            <button class="btn btn-outline-primary" @onclick="LoadProducts">
                <i class="fas fa-retry"></i>
                Try Again
            </button>
        </div>
    }
    else if (products?.Any() == true)
    {
        <div class="products-grid">
            @foreach (Product product in products)
            {
                <ProductCard Product="product" 
                             OnEdit="EditProduct" 
                             OnDelete="DeleteProduct" />
            }
        </div>
        
        <div class="products-summary">
            <p class="summary-text">
                <i class="fas fa-info-circle"></i>
                Showing @products.Length product(s) in inventory
            </p>
        </div>
    }
    else
    {
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-box-open"></i>
            </div>
            <h3>No Products Found</h3>
            <p>There are no products in the inventory yet.</p>
            <button class="btn btn-primary" @onclick="AddNewProduct">
                <i class="fas fa-plus"></i>
                Add Your First Product
            </button>
        </div>
    }
</div>

<AddProductModal IsVisible="showAddModal" 
                 OnClose="CloseAddModal" 
                 OnProductAdded="HandleProductAdded" />

<EditProductModal IsVisible="showEditModal" 
                  ProductToEdit="selectedProduct"
                  OnClose="CloseEditModal" 
                  OnProductUpdated="HandleProductUpdated" />

<DeleteProductModal IsVisible="showDeleteModal" 
                    ProductToDelete="productToDelete"
                    OnClose="CloseDeleteModal" 
                    OnProductDeleted="HandleProductDeleted" />

<AddCategoryModal IsVisible="showAddCategoryModal" 
                  OnClose="CloseAddCategoryModal" 
                  OnCategoryAdded="HandleCategoryAdded" />

<DeleteCategoryModal IsVisible="showDeleteCategoryModal" 
                     OnClose="CloseDeleteCategoryModal" 
                     OnCategoryDeleted="HandleCategoryDeleted" />

@code {
    private Product[]? products;
    private bool isLoading = true;
    private string? errorMessage;
    private bool showAddModal = false;
    private bool showEditModal = false;
    private bool showDeleteModal = false;
    private bool showAddCategoryModal = false;
    private bool showDeleteCategoryModal = false;
    private bool showCategoryDropdown = false;
    private Product? selectedProduct;
    private Product? productToDelete;
    
    // Pagination properties
    private int currentPage = 1;
    private int totalPages = 1;
    private bool hasPreviousPage = false;
    private bool hasNextPage = false;
    private const int pageSize = 6;

    protected override async Task OnInitializedAsync()
    {
        await LoadPage(1);
    }

    private async Task LoadPage(int pageNumber)
    {
        isLoading = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            var paginationResponse = await ApiService.GetProductsPaginatedAsync(pageNumber, pageSize);
            if (paginationResponse != null)
            {
                products = paginationResponse.Items;
                currentPage = paginationResponse.PageNumber;
                totalPages = paginationResponse.TotalPages;
                hasPreviousPage = paginationResponse.HasPreviousPage;
                hasNextPage = paginationResponse.HasNextPage;
            }
            else
            {
                products = Array.Empty<Product>();
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            Console.Error.WriteLine($"Error fetching products: {ex.Message}");
            products = Array.Empty<Product>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadProducts()
    {
        await LoadPage(1);
    }

    private async Task RefreshProducts()
    {
        await LoadProducts();
    }

    private void AddNewProduct()
    {
        showAddModal = true;
        StateHasChanged();
    }

    private void CloseAddModal()
    {
        showAddModal = false;
        StateHasChanged();
    }

    private async Task HandleProductAdded(Product newProduct)
    {
        // Refresh the products list to include the new product
        await LoadPage(currentPage);
    }

    private void EditProduct(Product product)
    {
        selectedProduct = product;
        showEditModal = true;
        StateHasChanged();
    }

    private void CloseEditModal()
    {
        showEditModal = false;
        selectedProduct = null;
        StateHasChanged();
    }

    private async Task HandleProductUpdated(Product updatedProduct)
    {
        // Refresh the products list to show the updated product
        await LoadPage(currentPage);
    }

    private void DeleteProduct(Product product)
    {
        productToDelete = product;
        showDeleteModal = true;
        StateHasChanged();
    }

    private void CloseDeleteModal()
    {
        showDeleteModal = false;
        productToDelete = null;
        StateHasChanged();
    }

    private async Task HandleProductDeleted(Product deletedProduct)
    {
        // Refresh the products list to remove the deleted product
        // If we're on a page that might be empty after deletion, go to previous page
        if (products?.Length == 1 && currentPage > 1)
        {
            await LoadPage(currentPage - 1);
        }
        else
        {
            await LoadPage(currentPage);
        }
    }

    private void ToggleCategoryDropdown()
    {
        showCategoryDropdown = !showCategoryDropdown;
        Console.WriteLine($"Dropdown state changed to: {showCategoryDropdown}");
        StateHasChanged();
    }

    private void CloseDropdownIfOpen()
    {
        if (showCategoryDropdown)
        {
            showCategoryDropdown = false;
            StateHasChanged();
        }
    }

    private void AddNewCategory()
    {
        showCategoryDropdown = false;
        showAddCategoryModal = true;
        StateHasChanged();
    }

    private void DeleteCategory()
    {
        showCategoryDropdown = false;
        showDeleteCategoryModal = true;
        StateHasChanged();
    }

    private void CloseAddCategoryModal()
    {
        showAddCategoryModal = false;
        StateHasChanged();
    }

    private void CloseDeleteCategoryModal()
    {
        showDeleteCategoryModal = false;
        StateHasChanged();
    }

    private async Task HandleCategoryAdded(Category newCategory)
    {
        // Refresh the products list to show updated categories
        await LoadPage(currentPage);
    }

    private async Task HandleCategoryDeleted(CategorySummary deletedCategory)
    {
        // Refresh the products list to show updated categories
        await LoadPage(currentPage);
    }
}